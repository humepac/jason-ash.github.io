<!doctype html>
<html lang="en">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no">
	
	<title>Jason Ash | Thought Archive</title>
	<meta name="description" content="Writing about probability & Bayesian inference, data visualization, puzzles & games, finance, and books">	
    
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/css/bootstrap.min.css" integrity="sha384-WskhaSGFgHYWDcbwN70/dfYBj47jz9qbsMId/iRN3ewGhXQFZCSftd1LZCfmhktB" crossorigin="anonymous">
    <link rel="stylesheet" href="theme/css/main.css">
    
	<!-- Google Analytics -->
	<script async src="https://www.googletagmanager.com/gtag/js?id=UA-122705782-1"></script>
	<script>
	  window.dataLayer = window.dataLayer || [];
	  function gtag(){dataLayer.push(arguments);}
	  gtag('js', new Date());

	  gtag('config', 'UA-122705782-1');
	</script>

	
    <!-- mathjax -->
    <script type="text/x-mathjax-config">MathJax.Hub.Config({tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]}});</script>
    <script type="text/javascript" async src="https://cdn.mathjax.org/mathjax/latest/MathJax.js?config=TeX-AMS_CHTML"></script>
    
  </head>
  <body>
    
<nav class="navbar navbar-expand-sm navbar-light bg-white sticky-top">
  <div class="container">

  <a class="navbar-brand" href="/index.html">Jason Ash</a>

  <div class="collapse navbar-collapse"> 
    <ul class="navbar-nav ml-auto">
      <li class="nav-item mr-4">
        <a class="nav-link" href="/index.html">Writing</a>
      </li>
      <li class="nav-item dropdown">
        <a class="nav-link dropdown-toggle" href="/resume.html" id="navbarDropdownMenuLink" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
          Resume
        </a>
        <div class="dropdown-menu" aria-labelledby="navbarDropdownMenuLink">
          <a class="dropdown-item" href="/resume.html">View</a>
          <a class="dropdown-item" href="/resume.pdf" target="_blank">Download</a>
        </div>
      </li>
    </ul>
  </div>  
  
  </div>
</nav>    
    <div class="container" style="min-height:88vh">
<div class="row justify-content-center">
  <div class="col-md-8">
  
    <div class="row mt-5">
      <div class="col">
        <div class="d-flex justify-content-between align-items-baseline mb-4">
          <h1>Puppy steps</h1>
          <label class="text-muted">Dec 5, 2018</label>
        </div>
        <div class="mb-5">
          <p><p>One of my recent favorite purchases was a <a href="https://www.amazon.com/Garmin-Fenix-Slate-Gray-Black/dp/B01N7J9APR" target="_blank">Garmin Fenix 5</a> watch. I bought it primarily to track a European cycling trip from <a href="https://www.strava.com/activities/1785505507" target="_blank">Regensburg, Germany</a> to <a href="https://www.strava.com/activities/1785507923" target="_blank">Vienna, Austria</a>. But I've also enjoyed keeping track of the steps I take each day. In particular, I wondered what inferences I could make about my life using the step data from the past few months.</p>
<p><img class="img-fluid mx-auto d-block" title="Follow Darcy on Instagram: @prideandprejudog" alt="Darcy" src="../images/darcy.jpg" style="height:300px;"></p>
<p>My wife and I recently got a puppy, Darcy. She's an energetic five-month-old, and to say our daily routines have changed as a result would be an understatement. My intuition was that I walked much more each day since Darcy arrived, and I wondered if the data, plus some Bayesian inference, would support my hypothesis. I was inspired by an example from <a href="http://nbviewer.jupyter.org/github/CamDavidsonPilon/Probabilistic-Programming-and-Bayesian-Methods-for-Hackers/blob/master/Chapter1_Introduction/Ch1_Introduction_PyMC3.ipynb" target="_blank">Bayesian Methods for Hackers</a>, by Cam Davidson-Pilon, where he examined text message patterns over a period of time.</p>
<h5>The question:</h5>
<p>Concretely, I want to determine if my step behavior changed over time. Was there a specific day or range of days where my activity increased or decreased? How much did my steps change? If I observed a change, what could I attribute it to?</p>
<p>I'll use the excellent <a href="https://docs.pymc.io/" target="_blank"><code>pymc3</code></a> library to construct a model to answer my question. The model consists of prior assumptions about the distribution of my steps as well as an inference engine to fit my data and estimate a posterior distribution. The posterior distribution will be used to estimate the likelihood that my behavior changed.</p>
<h5>The data:</h5>
<p>The first step was to gather the data from my Garmin watch. Unsurprisingly, this was not a very exciting process, but I eventually collected several months of step data, starting from the end of July. It looked something like this:</p>
<div class="highlight"><pre><span></span>             <span class="n">actual</span>    <span class="n">goal</span>
<span class="mi">2018</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">29</span>   <span class="mf">9250.0</span>  <span class="mf">7140.0</span>
<span class="mi">2018</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">30</span>   <span class="mf">6392.0</span>  <span class="mf">7360.0</span>
<span class="mi">2018</span><span class="o">-</span><span class="mo">07</span><span class="o">-</span><span class="mi">31</span>   <span class="mf">5668.0</span>  <span class="mf">7270.0</span>
<span class="mi">2018</span><span class="o">-</span><span class="mi">08</span><span class="o">-</span><span class="mo">01</span>  <span class="mf">10286.0</span>  <span class="mf">6950.0</span>
<span class="o">...</span>             <span class="o">...</span>     <span class="o">...</span>
<span class="mi">2018</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">22</span>   <span class="mf">7888.0</span>  <span class="mf">8520.0</span>
<span class="mi">2018</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">23</span>  <span class="mf">10532.0</span>  <span class="mf">8460.0</span>
<span class="mi">2018</span><span class="o">-</span><span class="mi">11</span><span class="o">-</span><span class="mi">24</span>  <span class="mf">11999.0</span>  <span class="mf">8670.0</span>
</pre></div>


<p><img class="img-fluid mx-auto d-block" title="Daily Step Count" alt="step count" src="../images/20181205-steps1.png" style="height:300px;"></p>
<p>(Garmin uses an algorithm to set an adjustable daily step goal. I was curious about the logic behind the algorithm, but I'll save it for another post.)</p>
<h5>The priors:</h5>
<p>I assume my steps are normally distributed with $mean=mu$ and $standard deviation=sd$. From the sample data, $mu=8637$ and $sd=2559$. Technically speaking a normal distribution allows for the possibility of a negative daily step count at the extreme left tail, but the probability of this is roughly 0.04%. I'm willing to accept this for the ease of using the normal distribution (as opposed to a strictly-positive distriution like the lognormal) for modeling. </p>
<p>I suspect that my step activity increased after the puppy arrived, so I'll set up two normal distributions, $N_1$ and $N_2$, to represent models for my steps before and after that point. If my hypothesis is correct, then the mean of $N_2$ will be greater than the mean of $N_1$. A third variable, tau, will identify the point at which the distributions shift.</p>
<p>Each normal distribution is parameterized by a mean and standard deviation. I don't want to embed strong priors other than to force the mean and standard deviation to be positive numbers. Therefore, I'll model them as exponential distributions. The exponential distribution takes a single parameter, alpha, which I'll set equal to the inverse of my sample mean and standard deviation, respectively. Similarly, I won't embded much prior knowledge about tau by assuming it is uniformly distributed across the time period.</p>
<h5>The model:</h5>
<p>Describing this model with <code>pymc3</code> is simple. I establish prior distributions for the parameters of the two normal distributions and let <code>pymc3</code> run inference on the model. The output is a large batch of samples from the posterior distribution, which I can use to answer my questions about step behavior.</p>
<div class="highlight"><pre><span></span><span class="k">with</span> <span class="n">pm</span><span class="o">.</span><span class="n">Model</span><span class="p">()</span> <span class="k">as</span> <span class="n">model</span><span class="p">:</span>

    <span class="c1"># parameterize the priors with sample mean and standard deviation</span>
    <span class="n">alpha</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">actual</span><span class="o">.</span><span class="n">mean</span><span class="p">()</span>
    <span class="n">beta</span> <span class="o">=</span> <span class="mi">1</span> <span class="o">/</span> <span class="n">data</span><span class="o">.</span><span class="n">actual</span><span class="o">.</span><span class="n">std</span><span class="p">()</span>

    <span class="c1"># normal distribution priors - mu and std for before and after</span>
    <span class="n">mu</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="s1">&#39;mu&#39;</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="n">alpha</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,])</span>
    <span class="n">sd</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Exponential</span><span class="p">(</span><span class="s1">&#39;sd&#39;</span><span class="p">,</span> <span class="n">lam</span><span class="o">=</span><span class="n">beta</span><span class="p">,</span> <span class="n">shape</span><span class="o">=</span><span class="p">[</span><span class="mi">2</span><span class="p">,])</span>

    <span class="n">t</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">data</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">tau</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">DiscreteUniform</span><span class="p">(</span><span class="s1">&#39;tau&#39;</span><span class="p">,</span> <span class="n">lower</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">upper</span><span class="o">=</span><span class="n">t</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
    <span class="n">_mu</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">tau</span> <span class="o">&gt;</span> <span class="n">t</span><span class="p">,</span> <span class="n">mu</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">mu</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">_sd</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">math</span><span class="o">.</span><span class="n">switch</span><span class="p">(</span><span class="n">tau</span> <span class="o">&gt;</span> <span class="n">t</span><span class="p">,</span> <span class="n">sd</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">sd</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>

    <span class="n">observation</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">Normal</span><span class="p">(</span><span class="s1">&#39;observation&#39;</span><span class="p">,</span> <span class="n">mu</span><span class="o">=</span><span class="n">_mu</span><span class="p">,</span> <span class="n">sd</span><span class="o">=</span><span class="n">_sd</span><span class="p">,</span> <span class="n">observed</span><span class="o">=</span><span class="n">data</span><span class="o">.</span><span class="n">actual</span><span class="p">)</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">find_MAP</span><span class="p">()</span>
    <span class="n">trace</span> <span class="o">=</span> <span class="n">pm</span><span class="o">.</span><span class="n">sample</span><span class="p">(</span><span class="n">draws</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">tune</span><span class="o">=</span><span class="mi">5000</span><span class="p">,</span> <span class="n">start</span><span class="o">=</span><span class="n">start</span><span class="p">)</span>
</pre></div>


<h5>The results:</h5>
<p>We can use the built-in visualization tools provided by <code>pymc3</code> to examine the posterior distribution parameters. For example, the most likely value for tau is slightly less than 40 days, but appears to range anywhere from 30 to 50 days from the beginning of the time period.</p>
<p>More interesting, I think, are the parameters of the two normal distributions. The green lines represent mean and standard deviation of $N_1$, while red lines represent $N_2$. I notice the $N_2$ mean appears to be slightly higher than $N_1$, but it doesn't appear to be a significant difference. In fact, the average sampled means from $N_1$ and $N_2$ are 8335 and 8735 - a difference of just 400 steps per day. However, the standard deviations of the normal distributions show much more divergence from each other. Prior to the switchpoint, the average standard deviation is 3452. After the switchpoint, it reduces to 2074. </p>
<p><img class="img-fluid mx-auto d-block" title="PYMC3 traceplot" alt="pymc3 traceplot" src="../images/20181205-steps2.png" style="height:300px;"></p>
<p>What can we conclude from this? Originally I suspected that my step count increased after the puppy arrived. There appears to be some slight truth to this, given that the model predicted an average 400 steps extra per day, but that's not overwhelming evidence. In fact, using the maximum a posteriori values for $N_1$ and $N_2$ we can estimate how likely it would be for step count to be higher after the puppy arrived. We sample repeatedly from each distribution and count the days where step count is higher from $N_2$. </p>
<div class="highlight"><pre><span></span><span class="c1"># sample from both normal distribution 100,000 times</span>
<span class="n">trials</span> <span class="o">=</span> <span class="mi">100000</span>
<span class="n">samples</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">random</span><span class="o">.</span><span class="n">normal</span><span class="p">(</span><span class="n">loc</span><span class="o">=</span><span class="n">start</span><span class="p">[</span><span class="s1">&#39;mu&#39;</span><span class="p">],</span> <span class="n">scale</span><span class="o">=</span><span class="n">start</span><span class="p">[</span><span class="s1">&#39;sd&#39;</span><span class="p">],</span> <span class="n">size</span><span class="o">=</span><span class="p">(</span><span class="n">trials</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
<span class="n">results</span> <span class="o">=</span> <span class="nb">sum</span><span class="p">(</span><span class="n">samples</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="n">samples</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">/</span> <span class="n">trials</span>

<span class="k">print</span><span class="p">(</span><span class="n">results</span><span class="p">)</span>
<span class="mf">0.49983</span>
</pre></div>


<p>Based on this, it appears I was no likelier to walk further after the puppy arrived. There was just a 50% chance that my step count would be higher with the puppy. This makes sense, based on the similarity of the sample means for $N_1$ and $N_2$.</p>
<p>Instead, the model suggests that the standard deviation of daily step count decreased, meaning the range of steps on a daily basis is much more consistent. Intuitively this feels like a better description of post-puppy life. Instead of significantly higher activity per day, our activity is more consistent: regular daily walks and exercise to try to establish routine for Darcy. </p>
<p>Also impressive is the ability of the model to pinpoint the timing of this shift. The chart below shows the average 95% range of steps predicted per day by the model. There is a clear shift to a narrower range of results starting on the day we got our puppy and taking about a week to settle into a final band. Therefore, my conclusion is that the model accurately identified the timing and effect of Darcy on my activity level.</p>
<p><img class="img-fluid mx-auto d-block" title="Final Results" alt="step count results" src="../images/20181205-steps3.png" style="height:300px;"></p></p>
        </div>
      </div>
    </div>

  </div>
</div>
    </div>     
    
<footer class="footer text-muted">
  <div class="container">    
    <p>
      Built with <a href="http://docs.getpelican.com/en/stable/" target="_blank">Pelican</a> and <a href="http://getbootstrap.com/" target="_blank">Bootstrap</a>.
      <br>
      &copy; 2018 Jason Ash. All rights reserved.
    </p>
  </div>
</footer>  
    <!-- optional scripts -->
    <script src="https://code.jquery.com/jquery-3.3.1.slim.min.js" integrity="sha384-q8i/X+965DzO0rT7abK41JStQIAqVgRVzpbzo5smXKp4YfRvH+8abtTE1Pi6jizo" crossorigin="anonymous"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/popper.js/1.14.3/umd/popper.min.js" integrity="sha384-ZMP7rVo3mIykV+2+9J3UJ46jBk0WLaUAdn689aCwoqbBJiSnjAK/l8WvCWPIPm49" crossorigin="anonymous"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.1.1/js/bootstrap.min.js" integrity="sha384-smHYKdLADwkXOn1EmN1qk/HfnUcbVRZyYmZ4qpPea6sjB/pTJ0euyQp0Mk8ck+5T" crossorigin="anonymous"></script>
    
  
  </body>
</html>